From 27f87dd8dea6a6ef6db79251a04e8e2d18970ef0 Mon Sep 17 00:00:00 2001
From: Iceows <mounierr07@gmail.com>
Date: Tue, 12 Jul 2022 02:30:29 +0200
Subject: [PATCH] Fix MediaProvider crash on Huawei device

---
 .../media/scan/ModernMediaScanner.java          | 17 ++++++++++++++---
 1 file changed, 14 insertions(+), 3 deletions(-)

diff --git a/src/com/android/providers/media/scan/ModernMediaScanner.java b/src/com/android/providers/media/scan/ModernMediaScanner.java
index 8927bfa5..6274337f 100644
--- a/src/com/android/providers/media/scan/ModernMediaScanner.java
+++ b/src/com/android/providers/media/scan/ModernMediaScanner.java
@@ -367,11 +367,22 @@ public class ModernMediaScanner implements MediaScanner {
             mRoot = root;
             mReason = reason;
 
+            MediaVolume VolumeTmp=null;
             if (FileUtils.contains(Environment.getStorageDirectory(), root)) {
-                mVolume = MediaVolume.fromStorageVolume(FileUtils.getStorageVolume(mContext, root));
-            } else {
-                mVolume = MediaVolume.fromInternal();
+                try {
+                    VolumeTmp = MediaVolume.fromStorageVolume(FileUtils.getStorageVolume(mContext, root));
+                }
+                catch (FileNotFoundException e)
+                {
+                    Log.w(TAG,"Can't find volume for " + root);
+                }
             }
+
+            if (VolumeTmp == null)
+                mVolume = MediaVolume.fromInternal();
+            else
+                mVolume=VolumeTmp;
+			
             mVolumeName = mVolume.getName();
             mFilesUri = MediaStore.Files.getContentUri(mVolumeName);
             mSignal = new CancellationSignal();
-- 
2.33.0.windows.2

